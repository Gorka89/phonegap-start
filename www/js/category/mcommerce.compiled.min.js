var $UPP=$UPP||{};$UPP.PROPS=$UPP.PROPS||{},function(){"use strict";var a=this;a.CATEGORY={NAME:"mcommerce"},a.CONF={MODULES:{ESHOP:{ADD2CART_AVAILABLE:!0}}}}.call($UPP.PROPS),function(a){"use strict";a.controller("upp.mcommerce.HomeCtrl",["$scope","$rootScope","$window","appi","eShopService","config",function(a,b,c,d,e,f){d.ui.changeActualOption({text:b.childuppName,navbarKey:"home"}),a.infiniteScroll=!0,a.listProducts=e.listEshopProducts,f.getLogoPath().then(function(b){a.logo=b}),f.getContent().then(function(b){b?(a.content=b,a.showProducts=!1):a.showProducts=!0})}])}(upp),function(a){"use strict";a.controller("upp.categories.mcommerce.OrdersCtrl",["$scope","ordersService","appi",function(a,b,c){c.security.securable({scope:a}).then(function(){c.ui.changeActualOption({i18n:"MCOMMERCE.MY-ORDERS.TITLE"}),c.ui.showPageLoadingMsg(),a.$PAYMENT_PAYPAL=1,a.$PAYMENT_REFUND=2,b.listOrders().then(function(d){var e=d.data;a.loaded=!0,a.orders=e.orders,a.currency=e.currency,c.ui.hidePageLoadingMsg(),a.openDetail=function(a){a.detailed?a.showDetail=!a.showDetail:b.retrieveOrder(a.id).then(function(b){var c=b.data;a.products=c.products,a.billingAddress=c.billingAddress,a.sendAddress=c.sendAddress,a.notes=c.notes,a.shippingCharges=c.shippingCharges,a.price=c.price,a.paymentModel=c.paymentModel,a.detailed=!0,a.showDetail=!0},function(){})}},function(){c.ui.showNetworkError()})})}])}(upp),function(a){"use strict";a["MCOMMERCE.MY-ORDERS.MENU"]="My orders",a["MCOMMERCE.MY-ORDERS.TITLE"]="My orders",a["MCOMMERCE.MY-ORDERS.DATE"]="Date",a["MCOMMERCE.MY-ORDERS.PRICE"]="Price",a["MCOMMERCE.MY-ORDERS.SENT"]="Sent",a["MCOMMERCE.MY-ORDERS.SHIPPING"]="Shipping Address",a["MCOMMERCE.MY-ORDERS.BILLING"]="Billing Address",a["MCOMMERCE.MY-ORDERS.OBSERVATIONS"]="Observations",a["MCOMMERCE.MY-ORDERS.AMOUNT"]="Amount",a["MCOMMERCE.MY-ORDERS.PRODUCT"]="Product",a["MCOMMERCE.MY-ORDERS.SIZE"]="Size",a["MCOMMERCE.MY-ORDERS.COLOR"]="Color",a["MCOMMERCE.MY-ORDERS.UNIT-PRICE"]="Price",a["MCOMMERCE.MY-ORDERS.TOTAL-PRICE"]="Total",a["MCOMMERCE.MY-ORDERS.SHIPPING-CHARGES"]="Shipping Charges",a["MCOMMERCE.MY-ORDERS.PAYMENT_METHOD"]="Payment method",a["MCOMMERCE.MY-ORDERS.PAID_WITH_PAYPAL"]="Paid with PayPal",a["MCOMMERCE.MY-ORDERS.PAY_ON_DELIVERY"]="Payment on delivery",a["MCOMMERCE.MY-ORDERS.NO-ORDER"]="There are no orders",a["MCOMMERCE.ORDER.SHIPPING-CHARGES"]="Shipping charges"}(translations.en),function(a){"use strict";a["MCOMMERCE.MY-ORDERS.MENU"]="Pedidos",a["MCOMMERCE.MY-ORDERS.TITLE"]="Pedidos",a["MCOMMERCE.MY-ORDERS.DATE"]="Fecha",a["MCOMMERCE.MY-ORDERS.PRICE"]="Precio",a["MCOMMERCE.MY-ORDERS.SENT"]="Enviado",a["MCOMMERCE.MY-ORDERS.SHIPPING"]="Dirección de envío",a["MCOMMERCE.MY-ORDERS.BILLING"]="Dir. de facturación",a["MCOMMERCE.MY-ORDERS.OBSERVATIONS"]="Observaciones",a["MCOMMERCE.MY-ORDERS.AMOUNT"]="Cantidad",a["MCOMMERCE.MY-ORDERS.PRODUCT"]="Producto",a["MCOMMERCE.MY-ORDERS.SIZE"]="Tamaño",a["MCOMMERCE.MY-ORDERS.COLOR"]="Color",a["MCOMMERCE.MY-ORDERS.UNIT-PRICE"]="Precio",a["MCOMMERCE.MY-ORDERS.TOTAL-PRICE"]="Total",a["MCOMMERCE.MY-ORDERS.SHIPPING-CHARGES"]="Gastos de envío",a["MCOMMERCE.MY-ORDERS.PAYMENT_METHOD"]="Método de pago",a["MCOMMERCE.MY-ORDERS.PAID_WITH_PAYPAL"]="Pago con PayPal",a["MCOMMERCE.MY-ORDERS.PAY_ON_DELIVERY"]="Pago contra-reembolso",a["MCOMMERCE.MY-ORDERS.NO-ORDER"]="No hay ningún pedido"}(translations.es),function(a){"use strict";a.service("accountManager",["$http","$location","$q","utils","$rootScope","appi",function(a,b,c,d,e,f){var g=$UPP.PROPS.URL_UPPLICATION_REST_SERVICE+"users/",h=function(a,b,c,d,e,h,i,j){if(a&&b&&c&&e&&i&&j){var k={name:a,surname:b,email:c,phone:d,password:e,address:h,captchaAnswer:i,captchaEncryptedAnswer:j};return f.http.post(g+"register",k)}throw new Error("required data not found")},i=function(a,b){if(a){var c={password:a,address:b};return f.http.postSecure(g+"account",c)}throw new Error("required data not found")},j=function(){return f.http.getSecure(g)},k=function(){return f.http.get(g+"captcha")},l=function(){return f.http.deleteSecure(g+"user")};return{register:h,update:i,remove:l,retrieve:j,getCaptchaImg:k}}]).config(["$routeProvider",function(a){a.when("/login/account",{templateUrl:"templates/category/login/account.html",resolve:{loadSecurity:["security",function(a){return a.initialize()}]}}).when("/register",{templateUrl:"templates/category/login/register.html"}).when("/register/ok",{templateUrl:"templates/category/login/register-ok.html"})}]).factory("accountStatusMessageHandler",["translator",function(a){function b(a,b,c){this.$scope=a,this.scopeErrorVar=b,this.scopeOkVar=c}var c=function(b,c){var d="",e=typeof c;c&&("object"===e&&c.translatedErrorMessage?d=c.translatedErrorMessage:"string"===e&&(d=a.i18n(c))),this.$scope[this.scopeErrorVar]={title:a.i18n(b),msg:d}},d=function(){this.$scope[this.scopeErrorVar]=void 0},e=function(){this.$scope[this.scopeOkVar]=!0},f=function(){this.$scope[this.scopeOkVar]=!1},g=function(){var a=angular.bind;return function(g,h,i){if(g){if(h||i){var j=new b(g,h,i);return h&&(j.showError=a(j,c),j.hideError=a(j,d)),i&&(j.showOk=a(j,e),j.hideOk=a(j,f)),j}throw new Error("handlers not found")}throw new Error("$scope not found")}}();return{create:g}}]).controller("upp.login.RegisterCtrl",["$rootScope","$scope","accountManager","appi","accountStatusMessageHandler","$timeout",function(a,b,c,d,e){var f=e.create(b,"registerError");b.register=function(a){a?(d.ui.showPageLoadingMsg(),c.register(b.name,b.surname,b.email,b.phone,b.password,b.address,b.captchaAnswer,b.captchaEncryptedAnswer).success(function(){d.location.path("/register/ok"),d.ui.hidePageLoadingMsg()}).error(function(a){f.showError("LOGIN.REGISTER.ERR.SERVER",a),b.submitted=!1,d.ui.hidePageLoadingMsg()})):(b.submitted=!0,f.showError("LOGIN.ERR.VALIDATION","LOGIN.ERR.VALIDATION.MSG"))},d.ui.changeActualOption({i18n:"LOGIN.REGISTER",navbarKey:"register"}),c.getCaptchaImg().success(function(a){b.captchaImgUrl=a.base64img,b.captchaEncryptedAnswer=a.answer})}]).controller("upp.login.AccountCtrl",["$scope","accountManager","security","appi","accountStatusMessageHandler","ordersService",function(a,b,c,d,e,f){var g=e.create(a,"updateError","updateOk"),h=function(c){g.hideOk(),g.hideError(),c?(d.ui.showPageLoadingMsg(),b.update(a.password,a.address).success(function(){g.showOk(),d.ui.hidePageLoadingMsg()}).error(function(b){g.showError("LOGIN.ACCOUNT.ERR.SERVER",b),a.submitted=!1,d.ui.hidePageLoadingMsg()})):(a.submitted=!0,g.showError("LOGIN.ERR.VALIDATION","LOGIN.ERR.VALIDATION.MSG"))},i=function(){var a=d.ui.showModalMessage,e=function(){a({title:"LOGIN.ACCOUNT.DELETE.MODAL.TITLE",message:"LOGIN.ACCOUNT.DELETE.MODAL1.MSG",closeButton:{text:"CANCEL"},confirmButton:{text:"LOGIN.ACCOUNT.DELETE.MODAL.CONFIRM",callback:g}})},g=function(){f.hasPendingOrders().then(function(a){a?setTimeout(h,500):j()},function(){d.ui.showNetworkError()})},h=function(){a({title:"LOGIN.ACCOUNT.DELETE.MODAL.TITLE",message:"LOGIN.ACCOUNT.DELETE.MODAL2.MSG",closeButton:{text:"CANCEL"},confirmButton:{text:"LOGIN.ACCOUNT.DELETE.MODAL.CONFIRM",callback:i}})},i=function(){j()},j=function(){b.remove().then(function(){c.logout()},function(){d.ui.showNetworkError()})};return function(){e()}}();c.securable({scope:a}).then(function(){d.ui.changeActualOption({i18n:"LOGIN.ACCOUNT"}),d.ui.showPageLoadingMsg(),b.retrieve().success(function(b){a.name=b.name,a.surname=b.surname,a.email=b.email,a.phone=b.phone,a.password=b.password,a.passwordConfirm=b.password,a.address=null==b.address?{}:b.address,a.update=h,a.delete=i,d.ui.hidePageLoadingMsg()}).error(function(){d.ui.showNetworkError()})})}]).directive("userDataTpl",function(){var a=angular.forEach;return{restrict:"E",templateUrl:"templates/category/login/user-data.html",replace:!0,link:function(b,c,d){if(d.fieldsRo){var e=d.fieldsRo.split(",");a(e,function(a){c.find("#"+a.trim()).prop("disabled",!0)})}d.requireCaptcha?b.captchaRequired=!0:c.find("#captchaControl").remove()}}})}(upp),function(a){"use strict";var b={authenticated:"login:authenticated",no_more_authenticated:"login:no_more_authenticated",open_login:"login:open-login",close_login:"login:close-login",close:"login:close"};a.factory("authenticationBuilder",function(){function a(a,b,c){this.username=a,this.principal=b,this.type=c}function b(a,b){this.username=a,this.password=b,this.type="UsernamePassword"}function c(a){this.username=void 0,this.token=a,this.type="Token"}function d(a,b,c,d,e,f){this.username=a,this.userId=c,this.admin=d,this.token=e,this.username_display=f}return a.prototype.isLogged=function(){return void 0!==this.principal},a.prototype.hasRole=function(){return!0},b.prototype.isLogged=function(){return!1},b.prototype.hasRole=function(){return!1},c.prototype.isLogged=function(){return!1},c.prototype.hasRole=function(){return!1},d.prototype.isAdmin=function(){return this.admin&&"boolean"==typeof this.admin},{build:function(b,c,e,f,g,h){var i=void 0;if(b){var j=!1,k=-1;e&&(j=e),c&&(k=c),i=new d(b,void 0,k,j,f,h)}return new a(b,i,g)},usernamePassword:function(a,c){return new b(a,c)},token:function(a){return new c(a)},anonymous:function(){return new a(void 0,void 0,"anonymous")}}}).service("contextHolderManager",["storage","authenticationBuilder",function(a,b){var c=function(){var c=void 0,d={authentication:b.anonymous()},e="upplicationToken",f=function(){return d},g=function(a){d.authentication=a,a.isLogged()||h(void 0)},h=function(b){c=b,a.set(e,b)},i=function(){return c||a.get(e)};return{get:f,setToken:h,getToken:i,setAuthentication:g}}();return{_setAuthentication:c.setAuthentication,_setToken:c.setToken,_getToken:c.getToken,get:c.get}}]).service("authManager",["$q","$http","securityUtils","utils","authenticationBuilder","contextHolderManager",function(a,c,d,e,f,g){var h=$UPP.PROPS.URL_UPPLICATION_REST_SERVICE+"users/",i=function(a,b){var c=a.data;return f.build(c.username,c.idUsuario,c.admin,c.token,b,c.username_display)},j=function(a,b){e.broadcast(a,b)},k=function(){return f.anonymous()},l=function(){var b=a.defer(),c=b.promise;return b.resolve(k()),c},m=function(){var a=function(a,b){return c.post(h+"login",{username:a,password:b})},b=function(b){return b&&b.username&&b.password?a(b.username,b.password).then(function(a){return i(a,"UsernamePassword")}):l()},e=function(){return c.post(h+"logout",{},d.getHttpAuthHeader()).then(function(){return k()})},f=function(a){return void 0!==a&&"UsernamePassword"===a.type};return{login:b,logout:e,check:f}}(),n=function(){var a=function(a){return c.post(h+"loginToken",{token:a})},b=function(b){return b&&b.token?a(b.token).then(function(a){return i(a,"Token")}):l()},e=function(){return c.post(h+"logout",{},d.getHttpAuthHeader()).then(function(){return k()})},f=function(a){return void 0!==a&&"Token"===a.type};return{login:b,logout:e,check:f}}(),o=function(a){var c=function(a){g._setAuthentication(a),void 0!==a.principal&&void 0!==a.principal.token&&g._setToken(a.principal.token),j(b.authenticated,a)},d=function(){var a=k();g._setAuthentication(a)};return m.check(a)?m.login(a).then(function(a){return a.isLogged()?c(a):d(),a},function(){return d(),f.anonymous()}):n.check(a)?n.login(a).then(function(a){return a.isLogged()?c(a):d(),a},function(){return d(),f.anonymous()}):l().then(function(){return d(),f.anonymous()})},p=function(){var a=k();j(b.no_more_authenticated,a),g._setAuthentication(a)},q=function(a){return m.check(a)?m.logout(a).then(function(a){return p(),a}):n.check(a)?n.logout(a).then(function(a){return p(),a}):l().then(function(){return p(),f.anonymous()})};return{login:o,logout:q}}]).service("securityUtils",["contextHolderManager",function(a){var b=function(){return a.get().authentication.isLogged()?{headers:{Authorization:"BASIC "+a._getToken()}}:void 0};return{getHttpAuthHeader:b}}]).service("security",["$location","$q","utils","$rootScope","contextHolderManager","authenticationBuilder","loginManager","authManager",function(a,c,d,e,f,g,h,i){var j=function(c,d){var e;c&&c.isLogged()&&d&&(e=d.scope)&&e.$on("event:"+b.no_more_authenticated,function(){a.path("/")})},k=function(){var a=c.defer(),b=a.promise;return a.resolve(g.anonymous()),b},l=function(a){var b=c.defer(),d=b.promise;return b.resolve(a),d},m=function(){var a=f.get().authentication;if(a.isLogged())return l(a);if(void 0===f._getToken())return k();var b=g.token(f._getToken());return i.login(b)},n=function(){return m()},o=function(b){return m().then(function(d){return d.isLogged()?d:b&&b.showError===!1?h.login():h.login().then(function(b){return b.isLogged()?b:("/register"!==a.path()&&a.path("login/needed"),c.reject())})},function(){return h.login()}).then(function(a){return j(a,b),a})};return{initialize:m,securable:o,getAuthentication:n,login:i.login,logout:i.logout}}]).service("loginManager",["$q","$rootScope","contextHolderManager",function(a,c,d){var e=function(){f();var e=a.defer(),g=e.promise,h=c.$on("event:"+b.close,function(){e.resolve(d.get().authentication),j()}),i=c.$on("event:"+b.authenticated,function(a,b){e.resolve(b),j()}),j=function(){h(),i()};return g},f=function(){c.$broadcast("event:"+b.open_login)},g=function(){c.$broadcast("event:"+b.close_login)};return{show:f,login:e,close:g}}]).service("signinManager",["authManager","authenticationBuilder","contextHolderManager","loginManager",function(a,b,c,d){var e=function(c,d){var e=b.usernamePassword(c,d);return a.login(e)},f=function(){var b=c.get().authentication;return a.logout(b)},g=function(){d.show()};return{login:e,logout:f,open:g}}]).config(["$routeProvider",function(a){a.when("/login/needed",{templateUrl:"templates/category/login/login-needed.html"})}]).controller("upp.login.SigninCtrl",["$scope","signinManager","security","contextHolderManager",function(a,b,c,d){a.openLogin=function(){b.open()},a.logout=function(){b.logout()},c.initialize().then(function(){a.context=d.get()})}]).directive("modalLoginTpl",["signinManager","utils",function(a,c){var d,e=function(a){a.error=!1,a.username="",a.pass="",a.remember=!1},f=function(b){b.error=!1,b.hideError=function(){b.error=!1},a.login(b.username,b.pass,b.remember).then(function(a){a.isLogged()?(d.modal("toggle"),b.error=!1):b.error=!0})};return{restrict:"E",replace:!0,templateUrl:"templates/category/login/login.html",controller:["$scope",function(a){a.checkLogin=function(){f(a)}}],link:function(a,g){a.$on("event:"+b.open_login,function(){d=d||g,e(a),d.modal("show"),d.one("shown",function(){$("#username, #pass").unbind("mouseup mousedown")}),d.one("hidden",function(){setTimeout(function(){a.$apply(function(){c.broadcast(b.close)})},500)}),d.unbind("keypress").bind("keypress",function(b){13==b.which&&(b.preventDefault(),f(a))}),a.$on("event:"+b.close_login,function(){d.modal("hide")})})}}}])}(upp),function(a){"use strict";a.config(["$routeProvider",function(a){a.when("/account/orders",{templateUrl:"templates/category/mcommerce-orders.html",showAd:!0})}])}(upp),function(a){"use strict";a.service("appi",["_appi","security","securityUtils",function(a,b,c){var d=this;angular.copy(a,d),d.security={securable:function(a){return b.securable(a)}},d.http.getSecure=function(a){return d.http.get(a,c.getHttpAuthHeader())},d.http.postSecure=function(a,b){return d.http.post(a,b,c.getHttpAuthHeader())},d.http.deleteSecure=function(a){return d.http.delete(a,c.getHttpAuthHeader())}}])}(upp),function(a){"use strict";a.service("ordersService",["$q","appi",function(a,b){var c=$UPP.PROPS.URL_UPPLICATION_REST_SERVICE+"orders",d=function(){return b.http.getSecure(c)},e=function(a){return b.http.getSecure(c+"/"+a)},f=function(){var d=a.defer();return b.http.getSecure(c+"/pending").then(function(a){var b=a.data&&a.data.orders&&a.data.orders.length;d.resolve(b)},function(a){d.reject(a)}),d.promise};return{listOrders:d,retrieveOrder:e,hasPendingOrders:f}}])}(upp);