!function(a){"use strict";var b="cart",c="CART.ORDER",d="CART.ADDRESS",e="/cart/";a.controller("upp.cart.OrderCtrl",["$scope","appi","cartService",function(a,c,d){var e=function(b,c){d.retrieveOrderList().then(function(c){var d=c.data;d.cartIsEmpty?a.order=[]:(a.order=d.order,a.currency=d.currency,a.prices={total:d.totalPriceWithoutTaxes,shippingCharges:d.shippingCharges,taxes:d.totalTaxes,totalPriceWithShippingCharges:d.totalPriceWithShippingCharges}),b&&b()},function(){c&&c()})};c.ui.changeActualOption({moduleKey2Display:b,navbarKey:b}),c.ui.showPageLoadingMsg(),e(function(){a.loaded=!0,c.ui.hidePageLoadingMsg()},function(){a.loaded=!0,c.ui.showNetworkError()}),a.$on("event:cart:recalculatePrices",function(){e()})}]),a.controller("upp.cart.AddressCtrl",["$scope","appi","cartService","storage",function(a,d,f,g){var h=angular.copy,i=function(){d.ui.changeActualOption({i18n:c,navbarKey:b},e+"order")};a.loaded=!1,f.checkOrder()?(g.set("redirectToCart",!0),d.security.securable({scope:a}).then(function(){i(),a.correct=!0,a.loaded=!0,g.remove("redirectToCart"),d.ui.showPageLoadingMsg(),f.checkStock().then(function(b){var c=b.isOrderCorrect();a.orderCorrect=c,c?(a.currency=f.getCurrency(),a.showShippingAddress=b.isShowShippingAddress(),a.shippingAddress=b.getShippingAddress(),a.billingAddress=b.getBillingAddress(),a.observations=b.getObservations(),a.price=b.getPrice(),a.stockStatusMsg="CART.STOCK-STATUS.OK.DESC",a.payPalEnabled=b.getPayPal(),a.refundEnabled=b.getRefund(),a.paymentModel=void 0,a.payPalEnabled?a.paymentModel=f.$PAYMENT_PAYPAL:a.refundEnabled&&(a.paymentModel=f.$PAYMENT_REFUND)):(a.unavailable=b.getUnavailable(),a.stockStatusMsg="CART.STOCK-STATUS.ERR.DESC"),d.ui.hidePageLoadingMsg()},function(){d.ui.showNetworkError()}),a.validPaymentModel=function(){return-1!==f.$PAYMENT_MODELS.indexOf(a.paymentModel)},a.next=function(){var b=a.shippingAddress,c=a.billingAddress;c&&c.sameAsShipping&&a.showShippingAddress?c=h(b):a.showShippingAddress||(c.sameAsShipping=!1);var e=f.getOrder();e.setShippingAddress(a.showShippingAddress?b:null),e.setBillingAddress(c),e.setObservations(a.observations),e.setPaymentModel(a.paymentModel),d.location.path("/cart/payment")}})):(i(),a.correct=!1,a.loaded=!0)}]),a.controller("upp.cart.PaymentCtrl",["$scope","appi","cartService","translator","storage",function(a,c,f,g,h){var i=function(){a.paymentError={title:g.i18n("CART.PAYMENT.ERR.SERVER.PREPARE.TITLE"),msg:g.i18n("CART.PAYMENT.ERR.SERVER.PREPARE.MSG")}};h.set("redirectToCart",!0),c.security.securable({scope:a}).then(function(){var g=f.getOrder();h.remove("redirectToCart"),c.ui.changeActualOption({i18n:d,navbarKey:b},e+"address"),a.correct=f.checkAddresses();var j,k;switch(g.getPaymentModel()){case f.$PAYMENT_REFUND:j=function(){c.ui.hidePageLoadingMsg(),c.location.path("/cart/payment/success")},k=function(){c.ui.hidePageLoadingMsg(),c.location.path("/cart/payment/failure")},a.paymentModel="REFUND";break;case f.$PAYMENT_PAYPAL:default:j=function(b){a.submitted=!0,b.paypalURL&&b.paypalURL.length?c.location.openWindowAndListenUrlChangeInPhonegap(b.paypalURL,[{urlListened:b.successURL,urlToOpen:"/cart/payment/success"},{urlListened:b.failURL,urlToOpen:"/cart/payment/failure"}]):(i(),c.ui.hidePageLoadingMsg())},k=function(){i(),c.ui.hidePageLoadingMsg()},a.paymentModel="PAYPAL"}a.doPayment=function(){c.ui.showPageLoadingMsg(),f.pay().success(j).error(k)}})}]),a.controller("upp.cart.SuccessCtrl",["$scope","cartService","appi",function(a,c,d){d.ui.changeActualOption({moduleKey2Display:b,navbarKey:b});var e=c.getOrder();c.emptyCart(),a.paymentModel=e.getPaymentModel(),a.PAYMENT_PAYPAL=c.$PAYMENT_PAYPAL,a.PAYMENT_REFUND=c.$PAYMENT_REFUND}]),a.controller("upp.cart.FailureCtrl",["appi",function(a){a.ui.changeActualOption({moduleKey2Display:b,navbarKey:b})}])}(upp),function(a){"use strict";a.directive("cartBreadcrumbTpl",["appi",function(a){var b=[{step:"order",label:"CART.ORDER",link:"/cart",next:{link:"/cart/address",label:"CART.NEXT",icon:"icon-chevron-right"}},{step:"address",label:"CART.ADDRESS",link:"/cart/address",next:{func:"next()",label:"CART.NEXT",icon:"icon-chevron-right"}},{step:"payment",label:"CART.PAYMENT"}],c=function(c,d){return a.utils.breadCrumbTemplate(c,b,d)};return{restrict:"E",replace:!0,compile:function(a,b){var d=c(b.cartStep,b.nextDisabled);a.replaceWith(d)}}}])}(upp),function(a){"use strict";a.directive("cartCurrentPageTpl",[function(){return{restrict:"E",replace:!0,template:'<current-page-tpl data-page-title="CART.KEY" data-page-key="cart"></current-page-tpl>'}}])}(upp),function(a){"use strict";a.directive("cartOrderProduct",["appi","cartService",function(a,b){var c=function(a,c){b.remove(c),a.$apply()},d=function(){b.updateNavBarCount()},e=function(){a.utils.broadcast("cart:recalculatePrices")},f=function(a){a.$watch("product.selectedStock",function(b){!isNaN(b)&&a.product.maxStock>=b&&(d(),e())})},g=function(b,d){var f=function(a,d){a.fadeOut(1e3,function(){c(b,d),e()})},g=function(b){a.ui.showModalMessage({title:"CART.ORDER.REMOVAL-CONFIRM.TITLE",message:"CART.ORDER.REMOVAL-CONFIRM.MSG",closeButton:{text:"CANCEL"},confirmButton:{text:"YES",callback:b}})};b.removeFromOrder=function(a){g(function(){f(d,a)})}};return{restrict:"C",link:function(a,b){f(a),g(a,b)}}}])}(upp),function(a){"use strict";a.directive("shippingBillingAddressTpl",[function(){return{scope:{address:"=",required:"=",hide:"=",addressType:"@"},replace:!0,restrict:"E",templateUrl:"templates/modules/cart/cart-shipping_billing_address.html"}}])}(upp),function(a){"use strict";a.factory("order",["product",function(a){function b(){this.id=void 0,this.products=[],this.isCorrect=!1,this.currency=void 0,this.price=void 0,this.paymentData=void 0,this.showShippingAddress=!0,this.shippingAddress=void 0,this.billingAddress=void 0,this.observations=void 0,this.unavailable=void 0,this.shippingCharges=void 0,this.payPal=!1,this.refund=!1,this.paymentModel=void 0}var c=angular.forEach,d=angular.equals,e=angular.copy;return b.prototype.initCurrency=function(a){if(!this.currency){if(!a)throw new Error("No currency");this.currency=a}},b.prototype.getProductsToCheckStock=function(){var a,b=this,d=[];return c(b.products,function(b){a=[],c(b.promotions,function(b){a.push(b.id)}),d.push({idProduct:b.id,promotions:a,idAttribute:b.selectedAttribute.id,number:b.selectedStock})}),d},b.prototype.getSelectedStock=function(){var a=this,b=0;return c.call(a,a.products,function(a){b+=a.selectedStock}),b},b.prototype.findProductById=function(a){for(var b,c=this,d=0,e=c.products.length;e>d;d++)if(b=c.products[d],b.id==a)return b;return void 0},b.prototype.removeProduct=function(){var a,b=function(b){for(var c,d=-1,e=0,f=a.products.length,g=b.selectedAttribute.id;f>e;e++)if(c=a.products[e],c.id==b.id&&c.selectedAttribute.id==g){d=e;break}return d};return function(c){a=this;var d=b(c);a.products.splice(d,1)}}(),b.prototype.addProduct=function(){var b,c=function(c){b.products.push(new a(c))};return function(d){if(b=this,!d)throw new Error("No product");var e=new a(d);if(!e.hasAttributesAndStock())throw new Error("Product without selected attributes");var f,g,h,i=0,j=this.products.length;for(h=e.selectedAttribute.id;j>i;i++)if(f=this.products[i],f.id==e.id&&f.selectedAttribute.id==h){f.selectedStock+=e.selectedStock,g=!0;break}g||c(e)}}(),b.prototype.setShippingAddress=function(a){this.shippingAddress=a},b.prototype.getShippingAddress=function(){return this.shippingAddress},b.prototype.setBillingAddress=function(a){var b=this.shippingAddress;a&&a.id&&b&&b.id?a.sameAsShipping=a.id===b.id&&d(a,b):a&&a.address&&a.postalCode&&a.city&&a.state&&a.country?(delete a.sameAsShipping,a.sameAsShipping=d(a,b)):a={sameAsShipping:!1},this.billingAddress=a},b.prototype.getBillingAddress=function(){return this.billingAddress},b.prototype.getBillingAddress4Server=function(){var a=e(this.billingAddress);return a&&delete a.sameAsShipping,a},b.prototype.setObservations=function(a){this.observations=a},b.prototype.getObservations=function(){return this.observations},b.prototype.setId=function(a){this.id=a},b.prototype.getId=function(){return this.id},b.prototype.setPaymentData=function(a){this.paymentData=a},b.prototype.getPaymentData=function(){return this.paymentData},b.prototype.setPrice=function(a){this.price=a},b.prototype.getPrice=function(){return this.price},b.prototype.setOrderIsCorrect=function(a){this.isCorrect=a},b.prototype.isOrderCorrect=function(){return this.isCorrect},b.prototype.setShowShippingAddress=function(a){this.showShippingAddress=a},b.prototype.isShowShippingAddress=function(){return this.showShippingAddress},b.prototype.setUnavailable=function(a){var b=[],d=this;c(a,function(a){b.push(d.findProductById(a.idProduct))}),this.unavailable=b},b.prototype.getUnavailable=function(){return this.unavailable},b.prototype.getProducts=function(){return this.products},b.prototype.getCurrency=function(){return this.currency},b.prototype.setShippingCharges=function(a){this.shippingCharges=a},b.prototype.getPayPal=function(){return this.payPal},b.prototype.setPayPal=function(a){this.payPal=a},b.prototype.getRefund=function(){return this.refund},b.prototype.setRefund=function(a){this.refund=a},b.prototype.getPaymentModel=function(){return this.paymentModel},b.prototype.setPaymentModel=function(a){this.paymentModel=a},b}])}(upp),function(a){"use strict";a["CART.KEY"]="Cart",a["CART.CONFIRM"]="Confirm",a["CART.NEXT"]="Next",a["CART.EMPTY-CART"]="Cart is empty!",a["CART.ADDRESS"]="Address",a["CART.ORDER"]="Order",a["CART.PAYMENT"]="Payment",a["CART.PRODUCT-ADDED"]="{0} products added to the cart",a["CART.PRODUCT-ADDED(1)"]="{0} product added to the cart",a["CART.GO-TO-CART"]="Go to cart",a["CART.ORDER.REMOVE"]="Remove product",a["CART.ORDER.PRICES.TOTAL"]="Price",a["CART.ORDER.PRICES.TAXES"]="Taxes",a["CART.ORDER.PRICES.SHIPPING-CHARGES"]="Shipping charges",a["CART.ORDER.PRICES.TOTALWITHTAXES"]="Price w/ taxes",a["CART.STOCK-STATUS"]="Stock Status",a["CART.STOCK-STATUS.OK"]="OK",a["CART.STOCK-STATUS.OK.DESC"]="All products have stock",a["CART.STOCK-STATUS.ERR"]="Err",a["CART.STOCK-STATUS.ERR.DESC"]="Some products are out of stock",a["CART.FINAL-PRICE"]="Final price",a["CART.ORDER.REMOVAL-CONFIRM.TITLE"]="Remove product of order",a["CART.ORDER.REMOVAL-CONFIRM.MSG"]="Are you really sure?",a["CART.ADDRESS.EDIT"]="Edit",a["CART.ADDRESS.SHIPPING"]="Shipping Address",a["CART.ADDRESS.BILLING"]="Billing Address",a["CART.ADDRESS.OBSERVATIONS"]="Observations",a["CART.ADDRESS.PAYMENT_MODEL"]="Payment method",a["CART.ADDRESS.PAY_WITH_PAYPAL"]="Pay now with PayPal",a["CART.ADDRESS.PAY_WITH_REFUND"]="Pay on delivery",a["CART.ADDRESS.SAME-AS-SHIPPING"]="As shipping",a["CART.PAYMENT.PAYPAL.ADVICE"]="You will be redirected to the PayPal website to do the payment.",a["CART.PAYMENT.PAYPAL.REDIRECTING"]="Redirecting to Paypal",a["CART.PAYMENT.PAYPAL.BTN"]="Pay with Paypal!",a["CART.PAYMENT.REFUND.ADVICE"]="You will confirm the payment for your order.",a["CART.PAYMENT.REFUND.REDIRECTING"]="Confirm your order",a["CART.PAYMENT.REFUND.BTN"]="Confirm order!",a["CART.PAYMENT.ERR.SERVER.PREPARE.TITLE"]="Error in payment.",a["CART.PAYMENT.ERR.SERVER.PREPARE.MSG"]="There has been an error preparing the payment. Contact with your administrator/seller.",a["CART.PAYMENT.SUCCESS.TITLE"]="Your payment has been received",a["CART.PAYMENT.SUCCESS.MSG"]="Thank you for your payment. Your transaction has been completed, and a receipt for your purchase has been emailed to you.",a["CART.PAYMENT.SUCCESS.TITLE_REFUND"]="Your order has been received",a["CART.PAYMENT.SUCCESS.MSG_REFUND"]="Thank you for your order. Your order has been completed, and a receipt for your purchase has been emailed to you.",a["CART.PAYMENT.FAILURE.TITLE"]="Error processing your payment",a["CART.PAYMENT.FAILURE.MSG"]="Sorry, we cannot complete your transaction because there has been an error processing the payment. Contact with your administrator/seller."}(translations.en),function(a){"use strict";a["CART.KEY"]="Cesta",a["CART.CONFIRM"]="Confirmar",a["CART.NEXT"]="Siguiente",a["CART.EMPTY-CART"]="¡La cesta está vacia!",a["CART.ADDRESS"]="Dirección",a["CART.ORDER"]="Pedido",a["CART.PAYMENT"]="Pago",a["CART.PRODUCT-ADDED"]="{0} productos añadidos a la cesta",a["CART.PRODUCT-ADDED(1)"]="{0} producto añadido a la cesta",a["CART.GO-TO-CART"]="Ir a la cesta",a["CART.ORDER.REMOVE"]="Eliminar producto",a["CART.ORDER.PRICES.TOTAL"]="Precio",a["CART.ORDER.PRICES.TAXES"]="IVA",a["CART.ORDER.PRICES.SHIPPING-CHARGES"]="Gastos de envío",a["CART.ORDER.PRICES.TOTALWITHTAXES"]="Total",a["CART.STOCK-STATUS"]="Estado del stock",a["CART.STOCK-STATUS.OK"]="OK",a["CART.STOCK-STATUS.OK.DESC"]="Todos los productos tienen stock",a["CART.STOCK-STATUS.ERR"]="Error",a["CART.STOCK-STATUS.ERR.DESC"]="Algún/os producto/s está/n fuera de stock",a["CART.FINAL-PRICE"]="Precio final",a["CART.ORDER.REMOVAL-CONFIRM.TITLE"]="Retirar producto del pedido",a["CART.ORDER.REMOVAL-CONFIRM.MSG"]="¿Estás seguro?",a["CART.ADDRESS.EDIT"]="Editar",a["CART.ADDRESS.SHIPPING"]="Dirección de envío",a["CART.ADDRESS.BILLING"]="Dir. de facturación",a["CART.ADDRESS.OBSERVATIONS"]="Observaciones",a["CART.ADDRESS.PAYMENT_MODEL"]="Método de pago",a["CART.ADDRESS.PAY_WITH_PAYPAL"]="Pagar ahora con PayPal",a["CART.ADDRESS.PAY_WITH_REFUND"]="Pagar a contra-reembolso",a["CART.ADDRESS.SAME-AS-SHIPPING"]="Igual que dirección de envío",a["CART.PAYMENT.PAYPAL.ADVICE"]="Serás reenviado a la página de PayPal para realizar el pago.",a["CART.PAYMENT.PAYPAL.REDIRECTING"]="Redirigiendo a PayPal",a["CART.PAYMENT.PAYPAL.BTN"]="¡Paga con PayPal!",a["CART.PAYMENT.REFUND.ADVICE"]="Vas a confirmar el pago de tu pedido.",a["CART.PAYMENT.REFUND.REDIRECTING"]="Confirmar el pedido",a["CART.PAYMENT.REFUND.BTN"]="¡Confirmar el pedido!",a["CART.PAYMENT.ERR.SERVER.PREPARE.TITLE"]="Error en el pago.",a["CART.PAYMENT.ERR.SERVER.PREPARE.MSG"]="Ha ocurrido un error realizando el pago. Contacta con tu administrador/Vendedor.",a["CART.PAYMENT.SUCCESS.TITLE"]="Tu pago ha sido recibido",a["CART.PAYMENT.SUCCESS.TITLE_REFUND"]="Tu pedido ha sido recibido",a["CART.PAYMENT.SUCCESS.MSG"]="Gracias por el pago. La transacción ha sido completada y se te ha enviado un email con la información de la compra.",a["CART.PAYMENT.SUCCESS.MSG_REFUND"]="Gracias por tu pedido. Todo ha ido bien y se te ha enviado un email con la información del pedido.",a["CART.PAYMENT.FAILURE.TITLE"]="Error procesando el pago",a["CART.PAYMENT.FAILURE.MSG"]="Lo lamentamos, no hemos podido completar la transacción, ha ocurrido un error procesando el pago. Contacta con tu administrador/vendedor."}(translations.es),function(a){"use strict";a.config(["$routeProvider",function(a){var b={resolve:a.ResolverFactory.moduleIsActivated("cart").resolver};a.when("/cart",{redirectTo:"/cart/order"}).when("/cart/order",{templateUrl:"templates/modules/cart/cart-order.html",resolve:b,showAd:!0}).when("/cart/address",{templateUrl:"templates/modules/cart/cart-address.html",resolve:b,showAd:!0}).when("/cart/payment",{templateUrl:"templates/modules/cart/cart-payment.html",resolve:b,showAd:!0}).when("/cart/payment/success",{templateUrl:"templates/modules/cart/cart-success.html",resolve:b,showAd:!0}).when("/cart/payment/failure",{templateUrl:"templates/modules/cart/cart-failure.html",resolve:b,showAd:!0})}])}(upp),function(a,b,c){"use strict";a.service("cartService",["appi","order","$q","product",function(a,d,e,f){var g=function(a){if(-1!==c.userAgent.indexOf("PhantomJS")||void 0===c.userAgent)return void 0;if(b.localStorage){var d=b.localStorage.getItem(a);return"undefined"===d?void 0:d}return void 0},h=function(a,d){return-1!==c.userAgent.indexOf("PhantomJS")||void 0===c.userAgent?void 0:void(b.localStorage&&("object"==typeof d&&(d=JSON.stringify(d),("{}"===d||"[]"===d)&&(d=void 0)),b.localStorage.setItem(a,d)))},i=function(){var a=g("cart"),b=Number(g("saveDate")),c=(new Date).getTime(),d=[];if(void 0===a||c/1e3>=b/1e3+86400)return h("cart",void 0),h("saveDate",void 0),void h("currency",void 0);a=JSON.parse(a);for(var e=0;e<a.length;e++)d.push(new f(a[e]));return d},j=function(a,b){h("cart",a.products),h("saveDate",(new Date).getTime()),void 0!==b&&h("currency",b)},k=$UPP.PROPS.URL_UPPLICATION_REST_SERVICE+"eshop/",l=$UPP.PROPS.URL_UPPLICATION_REST_SERVICE+"payment/",m=[1,2],n=1,o=2,p="cart",q=angular.forEach,r=function(){var a=i(),c=new d,e=g("currency");return a&&e&&(c.products=a,e=JSON.parse(e),e&&c.initCurrency(e),b.setTimeout(function(){t()},400)),c}(),s=function(){var b=function(a,b){return{message:{key:"CART.PRODUCT-ADDED",pluralize:a},closeButton:{text:"CLOSE"},confirmButton:{text:"CART.GO-TO-CART",callback:b}}},c=function(){var b=a.location.path;return function(){b("/cart")}}();return function(d){a.ui.showModalMessage(b(d,c))}}(),t=function(){a.ui.changeNavText(p,"("+r.getSelectedStock()+")")},u=function(a,b){r.initCurrency(b),r.addProduct(a),t(),s(a.selectedStock),j(r,b)},v=function(a){r.removeProduct(a),t(),j(r)},w=function(){return r},x=function(){return r.getCurrency()},y=function(a,b,c){for(var d,e,f=0,g=c.length;g>f;f++)if(e=c[f],e.idProduct===a&&e.idAttribute===b){d={unitPriceWithTaxes:e.pricePerUnitWithTaxes,unitPrice:e.pricePerUnitWithoutTaxes,totalPriceWithTaxes:e.priceWithTaxes,totalPrice:e.priceWithoutTaxes,amount:e.number};break}return d},z=function(a,b){return q(a,function(a){a.prices=y(a.id,a.selectedAttribute.id,b)}),a},A=function(){var b,c;if(!(c=r.getProducts())||!c.length){var d=e.defer();return d.resolve({data:{cartIsEmpty:!0}}),d.promise}return b=a.http.post(k+"price",{products:r.getProductsToCheckStock()}),b.success(function(a){a.order=z(c,a.productPrice),a.currency=r.getCurrency(),h("currency",a.currency),r.setShippingCharges(233.44)}),b},B=function(){var b=e.defer();return a.http.postSecure(k+"cart",{products:r.getProductsToCheckStock()}).success(function(a){var c;r.setOrderIsCorrect(a.correct),r.setId(a.idOrder),r.setPaymentData(a.paymentData),r.setPrice(a.price),r.setShowShippingAddress(a.shippingAddress),(c=a.unavailable)&&c.length&&r.setUnavailable(c),r.getShippingAddress()||r.setShippingAddress(a.sendAddress),r.getBillingAddress()||r.setBillingAddress(a.billingAddress),r.setPayPal(a.payPal),r.setRefund(a.refund),b.resolve(r)}),b.promise},C=function(){return r.getProducts().length>0},D=function(){return r.isOrderCorrect()&&r.getId()&&r.getPaymentData()&&r.getPrice()&&r.getCurrency()&&r.getBillingAddress()&&r.getShippingAddress()&&r.getProducts().length>0},E=function(a,b){var c;switch(a){case o:c="refundset";break;case n:default:c="paypalset"}return l+c+"/"+b},F=function(){var b=E(r.getPaymentModel(),r.id),c=a.http.postSecure(b,{sendAddress:r.getShippingAddress(),billingAddress:r.getBillingAddress4Server(),comments:r.getObservations(),paymentModel:r.getPaymentModel()});return c},G=function(){r=new d,t(),h("cart",void 0),h("saveDate",void 0),h("currency",void 0)};return{add:u,remove:v,getOrder:w,retrieveOrderList:A,getCurrency:x,updateNavBarCount:t,checkStock:B,checkOrder:C,checkAddresses:D,pay:F,emptyCart:G,$PAYMENT_MODELS:m,$PAYMENT_PAYPAL:n,$PAYMENT_REFUND:o}}])}(upp,window,navigator);