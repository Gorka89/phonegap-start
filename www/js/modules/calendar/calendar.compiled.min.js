!function(a){"use strict";var b=function(a){return"function"==typeof a.then};a.controller("upp.calendar.BookCtrl",["calendarService","calendarUtil","appi","$scope","storage","$timeout",function(a,c,d,e,f,g){d.ui.changeActualOption({moduleKey2Display:"bookings",navbarKey:"bookings"}),d.ui.showPageLoadingMsg(),e.reservation={attendants:1,comments:"",intervalSelected:""},e.calendar=0,a.getCalendars().then(function(a){e.calendars=a;var b=Number(f.get("bookingCalendar"));if(f.get("bookingDate")&&(e.dateContext=JSON.parse(f.get("bookingDate"))),e.calendars.length>0){if(b)for(var c=0,h=e.calendars;h>c;c++)if(Number(e.calendars[c].id)===b){e.calendar=e.calendars[c].id;break}0===e.calendar&&(e.calendar=e.calendars[0].id),e.selectCalendar(e.calendar),g(function(){e.reservation.attendants=Number(f.get("bookingNumPersons"))||1,e.reservation.comments=f.get("bookingComments")||""},500)}d.ui.hidePageLoadingMsg()},function(){d.ui.showNetworkError()});var h=new Date;e.dateContext={day:h.getUTCDate(),month:h.getUTCMonth(),year:h.getUTCFullYear()};var i=function(a){a.events=[],a.errorName="",a.reservation={attendants:1}};e.events=[],e.calendarData=c.generateMonth();var j=function(a,b){a.dateContext=b instanceof Date?{day:b.getDate(),month:b.getMonth(),year:b.getFullYear()}:b,i(a),a.dateSelected.setMonth(a.dateContext.month),a.dateSelected.setDate(a.dateContext.day),a.dateSelected.setFullYear(a.dateContext.year)};e.$on("calendar:reloadMonth",function(c,f){e.reservation.intervalSelected="",j(e,f);var g=a.getMonthlyCalendar(e.calendar,e.dateContext);b(g)?g.then(function(a){e.calendarData=a},function(){d.ui.showNetworkError()}):(e.calendarData=g,d.ui.hidePageLoadingMsg())}),e.$on("calendar:daySelected",function(b,c){j(e,c),d.ui.showPageLoadingMsg(),a.getIntervals(e.calendar,e.dateContext).then(function(a){e.events=a,e.reservation.intervalSelected=Number(f.get("bookingIntervalId"))||"",e.selectInterval(e.reservation.intervalSelected),d.ui.hidePageLoadingMsg()},function(){d.ui.showNetworkError()})}),e.selectCalendar=function(c){e.reservation.intervalSelected="";var f=Number(c);if(!isNaN(f)&&f>0){e.calendar=f;for(var g=0;g<e.calendars.length;g++){var h=e.calendars[g];h.id===f&&(e.calendarContext=h)}d.ui.showPageLoadingMsg();var i=a.getMonthlyCalendar(f,e.dateContext);b(i)?i.then(function(a){e.calendarData=a,d.ui.hidePageLoadingMsg(),e.$emit("calendar:daySelected",e.dateContext)},function(){d.ui.showNetworkError()}):(e.calendarData=i,d.ui.hidePageLoadingMsg(),e.$emit("calendar:daySelected",e.dateContext))}},e.selectInterval=function(a){Array.isArray(e.events)&&e.events.forEach(function(b){b.id===Number(a)&&(e.event=b)})},e.dateSelected=new Date,e.makeReservation=function(){f.set("redirectToBookings","true"),f.set("bookingIntervalId",e.reservation.intervalSelected),f.set("bookingNumPersons",e.reservation.attendants),f.set("bookingComments",e.reservation.comments),f.set("bookingDate",JSON.stringify(e.dateContext)),f.set("bookingCalendar",e.calendar),d.security.securable({scope:e}).then(function(b){if(void 0!==b.username){for(var c=["redirectToBookings","bookingDate","bookingIntervalId","bookingNumPersons","bookingComments","bookingCalendar"],g=0,h=c.length;h>g;g++)f.remove(c[g]);var j=angular.extend(angular.copy(e.reservation),e.dateContext);d.ui.showPageLoadingMsg(),a.makeReservation(j).then(function(a){e.errorName=a.message,d.ui.hidePageLoadingMsg(),"SUCCESS"===a.message?(i(e),d.location.path("/bookings/success")):"EVENT_PAST"===a.message&&(e.eventPastError=!0)},function(){d.ui.showNetworkError()})}})}}]),a.controller("upp.calendar.MyBookingsCtrl",["$scope","bookingsService","appi",function(a,b,c){c.security.securable({scope:a}).then(function(){c.ui.changeActualOption({i18n:"CALENDAR.BOOKINGS.TITLE"}),c.ui.showPageLoadingMsg(),b.listCalendars().then(function(b){a.calendars=b,a.calendarSelected=""},function(){c.ui.showNetworkError()}),b.listBookings().then(function(b){a.loaded=!0,a.bookings=b,c.ui.hidePageLoadingMsg(),a.openDetail=function(a){a.showDetail=!a.showDetail}},function(){c.ui.showNetworkError()}),a.cancelBooking=function(a){c.ui.showPageLoadingMsg(),b.cancelBooking(a.id).then(function(b){c.ui.hidePageLoadingMsg(),"SUCCESS"===b&&(a.status=3)},function(){c.ui.showNetworkError()})}})}])}(upp),function(a){"use strict";a.directive("monthCalendar",[function(){return{restrict:"E",templateUrl:"templates/modules/calendar/calendar-monthly_calendar.html",controller:["$scope","calendarUtil",function(a,b){a.prevMonth=function(){a.date.month--,a.date.month<0&&(a.date.year--,a.date.month=11),a.$emit("calendar:reloadMonth",a.date)},a.nextMonth=function(){a.date.month++,a.date.month>11&&(a.date.year++,a.date.month=0),a.$emit("calendar:reloadMonth",a.date)},a.daySelected=function(b,c,d){Number(b)>0&&(a.date.day=b,a.date.month=c,a.date.year=d),a.$emit("calendar:daySelected",a.date)},a=angular.extend(a,b)}],transclude:!0,scope:{date:"=",data:"=",calendar:"="}}}])}(upp),function(a){"use strict";a.directive("datePicker",[function(){return{restrict:"E",templateUrl:"templates/modules/calendar/calendar-datepicker-directive.html",controller:["$scope","calendarUtil",function(a,b){a.currentDate=new Date,a.currentDate.setDate(1),a.model=new Date,a.selectorOpened=!1,a.calendar=b.generateMonth(),a.toggleSelector=function(){a.selectorOpened=!a.selectorOpened},a.moveMonth=function(c){a.currentDate.setMonth(a.currentDate.getMonth()+(c>0?1:-1)),a.calendar=b.generateMonth(a.currentDate.getMonth(),a.currentDate.getFullYear()),a.$emit("calendar:reloadMonth",a.currentDate)},a.selectDay=function(b){var c=new Date;c.setFullYear(a.currentDate.getFullYear()),c.setMonth(a.currentDate.getMonth()),c.setDate(b),a.model=c,a.selectorOpened=!1,a.$emit("calendar:daySelected",a.model)},a=angular.extend(a,b),$("body").click(function(){a.$apply(function(){a.selectorOpened=!1})})}],transclude:!0,scope:{model:"="}}}])}(upp),function(a){"use strict";a.MONDAY="Monday",a.TUESDAY="Tuesday",a.WEDNESDAY="Wednesday",a.THURSDAY="Thursday",a.FRIDAY="Friday",a.SATURDAY="Saturday",a.SUNDAY="Monday",a.MONDAY_SHORT="M",a.TUESDAY_SHORT="T",a.WEDNESDAY_SHORT="W",a.THURSDAY_SHORT="T",a.FRIDAY_SHORT="F",a.SATURDAY_SHORT="S",a.SUNDAY_SHORT="S",a.CHOOSE_CALENDAR="Choose a calendar",a.ALL_CALENDARS="All calendars",a.JANUARY="January",a.FEBRUARY="February",a.MARCH="March",a.APRIL="April",a.MAY="May",a.JUNE="June",a.JULY="July",a.AUGUST="August",a.SEPTEMBER="September",a.OCTOBER="October",a.NOVEMBER="November",a.DECEMBER="December",a["CALENDAR.KEY"]="Bookings",a["CALENDAR.MY_BOOKINGS"]="My bookings",a.MAKE_RESERVATION="Make a reservation",a["CALENDAR.DATE"]="Date",a["CALENDAR.DATE_PLACEHOLDER"]="Reservation date",a["CALENDAR.CANCEL_RESERVATION"]="Cancel booking",a["CALENDAR.INTERVAL"]="Interval",a["CALENDAR.INTERVAL_PLACEHOLDER"]="Select an interval",a["CALENDAR.MAX_ATTENDANTS"]="Number of persons",a["CALENDAR.COMMENTS"]="Comments",a["CALENDAR.COMMENTS_PLACEHOLDER"]="Write a comment...",a["CALENDAR.AVAILABLE"]="available",a["CALENDAR.EVENT_NOT_AVAILABLE"]="There is no place to make a reservation for the number of persons you entered. Maybe someone made a reservation while you were making yours.",a["CALENDAR.INVALID_EVENT"]="The selected interval is not valid.",a["CALENDAR.EVENT_PAST"]="The selected interval is in the past, you can not select it.",a["CALENDAR.BOOKING_SUCCESS_TITLE"]="You have successfully made a reservation",a["CALENDAR.BOOKING_SUCCESS_MSG"]="You have just made a reservation but you still have to receive a confirmation. When you receive the confirmation the reservation will be valid and you will be able to enjoy your reservation.",a["CALENDAR.NO-BOOKINGS"]="There are no bookings.",a["CALENDAR.STATUS"]="Status",a["CALENDAR.PENDING"]="Waiting",a["CALENDAR.ACCEPTED"]="Accepted",a["CALENDAR.USER_DENIED"]="Cancelled",a["CALENDAR.CREATOR_DENIED"]="Denied",a["CALENDAR.CALENDAR"]="Calendar",a["CALENDAR.ATTENDANTS"]="Attendants",a["BOOKINGS.MENU"]="My bookings"}(translations.en),function(a){"use strict";a.MONDAY="Lunes",a.TUESDAY="Martes",a.WEDNESDAY="Miércoles",a.THURSDAY="Jueves",a.FRIDAY="Viernes",a.SATURDAY="Sábado",a.SUNDAY="Domingo",a.MONDAY_SHORT="L",a.TUESDAY_SHORT="M",a.WEDNESDAY_SHORT="X",a.THURSDAY_SHORT="J",a.FRIDAY_SHORT="V",a.SATURDAY_SHORT="S",a.SUNDAY_SHORT="D",a.CHOOSE_CALENDAR="Elige un calendario",a.ALL_CALENDARS="Todos los calendarios",a.JANUARY="Enero",a.FEBRUARY="Febrero",a.MARCH="Marzo",a.APRIL="Abril",a.MAY="Mayo",a.JUNE="Junio",a.JULY="Julio",a.AUGUST="Agosto",a.SEPTEMBER="Septiembre",a.OCTOBER="Octubre",a.NOVEMBER="Noviembre",a.DECEMBER="Diciembre",a["CALENDAR.KEY"]="Reservas",a["CALENDAR.MY_BOOKINGS"]="Mis reservas",a.MAKE_RESERVATION="Haz tu reserva",a["CALENDAR.DATE"]="Fecha",a["CALENDAR.DATE_PLACEHOLDER"]="Fecha de la reserva",a["CALENDAR.CANCEL_RESERVATION"]="Cancelar reserva",a["CALENDAR.INTERVAL"]="Intervalo",a["CALENDAR.INTERVAL_PLACEHOLDER"]="Selecciona un intervalo",a["CALENDAR.MAX_ATTENDANTS"]="Número de personas",a["CALENDAR.COMMENTS"]="Comentarios",a["CALENDAR.COMMENTS_PLACEHOLDER"]="Escribe un comentario...",a["CALENDAR.AVAILABLE"]="disponible/s",a["CALENDAR.EVENT_NOT_AVAILABLE"]="No hay espacio para hacer una reserva con el número de asistentes introducido. Quizás alguien ha hecho una reserva mientras hacía la suya.",a["CALENDAR.INVALID_EVENT"]="El intervalo seleccionado no es válido.",a["CALENDAR.EVENT_PAST"]="El intervalo seleccionado ya ha pasado, no puedes seleccionarlo.",a["CALENDAR.BOOKING_SUCCESS_TITLE"]="Ha realizado su reserva correctamente",a["CALENDAR.BOOKING_SUCCESS_MSG"]="Acabas de hacer una petición de reserva. Aún tienes que recibir la confirmación. Una vez recibas la confirmación la reserva será válida y podrás disfrutar de tu reserva.",a["CALENDAR.NO-BOOKINGS"]="No hay ninguna reserva.",a["CALENDAR.STATUS"]="Estado",a["CALENDAR.PENDING"]="Pendiente",a["CALENDAR.ACCEPTED"]="Aceptada",a["CALENDAR.USER_DENIED"]="Cancelada",a["CALENDAR.CREATOR_DENIED"]="Denegada",a["CALENDAR.CALENDAR"]="Calendario",a["CALENDAR.ATTENDANTS"]="Asistentes",a["BOOKINGS.MENU"]="Mis reservas"}(translations.es),function(a){"use strict";a.config(["$routeProvider",function(a){var b={resolve:a.ResolverFactory.moduleIsActivated("bookings").resolver};a.when("/bookings",{templateUrl:"templates/modules/calendar/calendar-book.html",resolve:b}).when("/bookings/success",{templateUrl:"templates/modules/calendar/calendar-booking_success.html"}).when("/account/bookings",{templateUrl:"templates/modules/calendar/calendar-my_bookings.html",resolve:b})}])}(upp),function(a){"use strict";var b=$UPP.PROPS.URL_UPPLICATION_REST_SERVICE+"calendar";a.service("calendarUtil",[function(){var a=["MONDAY","TUESDAY","WEDNESDAY","THURSDAY","FRIDAY","SATURDAY","SUNDAY"],b=a.map(function(a){return a+"_SHORT"}),c=["JANUARY","FEBRUARY","MARCH","APRIL","MAY","JUNE","JULY","AUGUST","SEPTEMBER","OCTOBER","NOVEMBER","DECEMBER"],d=function(a){for(var b=[],c=[],d=0,e=0;e<a.length;e++)c.push(a[e]),7===++d&&(b.push(angular.copy(c)),c=[],d=0);return c.length>0&&b.push(angular.copy(c)),b},e=function(a,b){void 0===a&&void 0===b&&(a=(new Date).getMonth(),b=(new Date).getFullYear());for(var c=function(c){return new Date(b,a,c)},e=new Date(b,a+1,0),f=[],g=1;g<=e.getDate();g++){var h=c(g);if(1===g){var i=h.getDay();0===i&&(i=7);for(var j=1;i>j;j++)f.push({isEmpty:!0,day:"",month:0,year:0,hasEvents:!1,isDisabled:!1})}f.push({isEmpty:!1,day:h.getDate(),month:h.getMonth(),year:h.getFullYear(),hasEvents:!1,isDisabled:!1})}return{days:d(f),monthDisabled:!1,disabledDays:[!1,!1,!1,!1,!1,!1,!1]}};return{weekDays:a,shortWeekDays:b,months:c,splitInChunksOfSeven:d,generateMonth:e}}]),a.service("calendarService",["appi","$q","calendarUtil",function(a,c,d){var e=function(c,d){var e,f=d.copy;return function(){var d=c.defer();return e?d.resolve(e):a.http.get(b+"/list").then(function(a){e=f(a.data).calendars||[],d.resolve(e)},function(a){d.reject(a)}),d.promise}}(c,angular),f=function(e,f){var g=c.defer();return e?(a.http.get(b+"/"+e+"/for_date/"+f.year+"/"+f.month).then(function(a){var b=angular.copy(a.data);b.days=[];for(var c=0;c<a.data.days.length;c++){var e=new Date(a.data.days[c].day.replace("CEST ","").replace("CET",""));if(0===c){var f=e.getDay();0===f&&(f=7);for(var h=1;f>h;h++)b.days.push({isEmpty:!0,day:"",month:0,year:0,hasEvents:!1,isDisabled:!1})}b.days.push({isEmpty:!1,day:e.getDate(),month:e.getMonth(),year:e.getFullYear(),hasEvents:a.data.days[c].events>0,isDisabled:a.data.days[c].restrictions>0})}b.days=d.splitInChunksOfSeven(b.days),g.resolve(b)},function(a){g.reject(a)}),g.promise):d.generateMonth(f.month,f.year)},g=function(d,e){var f=c.defer();return d?a.http.get(b+"/"+d+"/intervals_for_date/"+e.year+"/"+e.month+"/"+e.day).then(function(a){a.data.events=a.data.events.map(function(a){return a.interval=a.start+" - "+a.end,a}),f.resolve(a.data.events)},function(a){f.reject(a)}):f.resolve([]),f.promise},h=function(d){var e=c.defer();return a.http.postSecure(b+"/booking/new",d).then(function(a){e.resolve(a.data)},function(a){e.reject(a)}),e.promise};return{getCalendars:e,getMonthlyCalendar:f,getIntervals:g,makeReservation:h}}]),a.service("bookingsService",["appi","$q",function(a,c){var d=function(){var d=c.defer(),e=new Date;return a.http.getSecure(b+"/bookings/mine").then(function(a){var b=a.data.bookings.map(function(a){var b=a.hourStart.split(":").map(function(a){return Number(a)}),c=b[0],d=b[1],f=new Date(a.day);return f.setHours(c),f.setMinutes(d),a.past=f.getTime()<e.getTime(),a});d.resolve(b)},function(a){d.reject(a)}),d.promise},e=function(c,d){var e,f=d.copy;return function(){var d=c.defer();return e?d.resolve(e):a.http.getSecure(b+"/user_calendars").then(function(a){e=f(a.data).calendars||[],d.resolve(e)},function(a){d.reject(a)}),d.promise}}(c,angular),f=function(d){var e=c.defer();return a.http.postSecure(b+"/booking/cancel/"+d).then(function(a){e.resolve(a.data.message)},function(a){e.reject(a)}),e.promise};return{listBookings:d,listCalendars:e,cancelBooking:f}}])}(upp);